#!/system/bin/sh

#GET USER PREFERENCES
echo "*********************************************"
echo "**Configurator for Mosh-Kernel for i9105(P)**"
echo "*********************************************"
echo
echo

# swappiness
continue=0
while [ "$continue" -eq "0" ]; do
  echo "Wich default swapiness do you want, 0-100 is possible?(45)"
  read swappiness
  if [ "$swappiness" -ge "0" ] && [ "$swappiness" -le "100" ]; then
    echo "swappiness: "$swappiness
    continue=1
    echo $swappiness > /proc/sys/vm/swappiness
  else
    echo $swappiness" is not a valid input."
  fi
  sleep 1
done

# governor
continue=0
while [ "$continue" -eq "0" ]; do
  echo "Wich cpufreq governor do you want to use?"
  echo "Possible governors are: " $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors)
  read governor
  for word in $(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_available_governors); do
    if [ "$governor" = "$word" ]; then
      continue=1
    fi
  done
  if [ "$continue" = "1" ]; then
    echo "governor: "$governor
    echo $governor > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
  else
    echo $governor" is not a valid input."
  fi
  sleep 1
done
    
# I/O schedluer
continue=0
while [ "$continue" -eq "0" ]; do
  echo "Wich I/O scheduler do you want to use?"
  echo "Possible governors are: " $(cat /sys/block/mmcblk0/queue/scheduler)
  read iosched
  for word in $(cat /sys/block/mmcblk0/queue/scheduler); do
    if [ "$iosched" = "$word" ] || [ "[$iosched]" = "$word" ]; then
      continue=1
      break
    fi
  done
  if [ "$continue" = "1" ]; then
    echo "I/O Scheduler: "$iosched
    echo $iosched > /sys/block/mmcblk0/queue/scheduler
  else
    echo $iosched" is not a valid input."
  fi
  sleep 1
done

# overclocking
continue=0
while [ "$continue" -eq "0" ]; do
  echo "Do you want to overlock your cpu to 1.3 Ghz?(0/1)"
  read oc
  if [ "$oc" -eq "0" ] || [ "$oc" -eq "1" ]; then
    if [ "$oc" -eq "1" ]; then
      echo 1300000 > /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
    else 
      echo 1200000 > /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
    fi
    continue=1
  else 
    echo $oc" is not a valid input."
  fi
  sleep 1
done


#INIT.D SCRIPT
continue=0
while [ "$continue" -eq "0" ]; do
config_file="system/etc/init.d/mosh_kernel_config"

mount -o rw,remount /dev/block/mmcblk0p19 /system

  echo "Do you want to save these settings as default?(0/1)"
  read default
  if [ "$default" -eq "1" ]; then
  
    if [ ! -d "/system/etc/init.d" ]; then
      echo "You need init.d support for that"
      break
    fi
    
    if [ -f config_file ]; then
      rm $config_file
    fi
  
    touch $config_file
    
    if [ "$oc" -eq "1" ]; then
      cpufreq=1300000
    else
      cpufreq=1200000
    fi
    
    echo -e "#!/system/bin/sh\n\necho "$swappiness" > /proc/sys/vm/swappiness\necho "$governor" > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor\necho "$iosched" > /sys/block/mmcblk0/queue/scheduler\necho "$cpufreq" > /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq" > $config_file
    chmod 755 $config_file
    mount -o ro,remount,errors=panic /dev/block/mmcblk0p19 /system
    
  fi
  if [ "$default" -eq "0" ] || [ "$default" -eq "1" ]; then
    continue=1
  else
    echo $default" is not a valid input"
  fi
done 
 
